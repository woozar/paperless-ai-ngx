generator client {
  provider = "prisma-client-js"
  output   = "../generated/client"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// App Settings (Key-Value Store)
// =============================================================================

model Setting {
  settingKey   String   @id // e.g. "security.sharing.mode"
  settingValue String // e.g. "basic" | "advanced"
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// =============================================================================
// User & Permissions
// =============================================================================

enum UserRole {
  DEFAULT
  ADMIN
}

model User {
  id                 String   @id @default(cuid())
  username           String   @unique
  passwordHash       String
  role               UserRole @default(DEFAULT)
  mustChangePassword Boolean  @default(true) // New users must change initial password
  isActive           Boolean  @default(true) // Soft-delete: false = suspended
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Owned resources
  ownedPaperlessInstances PaperlessInstance[]
  ownedAiProviders        AiProvider[]
  ownedAiBots             AiBot[]

  // Shared access
  sharedPaperlessInstances UserPaperlessInstanceAccess[]
  sharedAiProviders        UserAiProviderAccess[]
  sharedAiBots             UserAiBotAccess[]

  // Usage tracking
  aiUsageMetrics AiUsageMetric[]

  @@index([role])
  @@index([isActive])
}

// Permission levels for shared resources
enum Permission {
  READ
  WRITE
  ADMIN
}

// Join table: User <-> PaperlessInstance (shared access)
model UserPaperlessInstanceAccess {
  id         String            @id @default(cuid())
  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  instance   PaperlessInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  instanceId String
  permission Permission        @default(READ)
  createdAt  DateTime          @default(now())

  @@unique([userId, instanceId])
  @@index([userId])
  @@index([instanceId])
}

// Join table: User <-> AiProvider (shared access)
model UserAiProviderAccess {
  id           String     @id @default(cuid())
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       String
  aiProvider   AiProvider @relation(fields: [aiProviderId], references: [id], onDelete: Cascade)
  aiProviderId String
  permission   Permission @default(READ)
  createdAt    DateTime   @default(now())

  @@unique([userId, aiProviderId])
  @@index([userId])
  @@index([aiProviderId])
}

// Join table: User <-> AiBot (shared access)
model UserAiBotAccess {
  id         String     @id @default(cuid())
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String
  aiBot      AiBot      @relation(fields: [aiBotId], references: [id], onDelete: Cascade)
  aiBotId    String
  permission Permission @default(READ)
  createdAt  DateTime   @default(now())

  @@unique([userId, aiBotId])
  @@index([userId])
  @@index([aiBotId])
}

// =============================================================================
// Paperless-NGX Integration
// =============================================================================

model PaperlessInstance {
  id        String   @id @default(cuid())
  name      String
  apiUrl    String
  apiToken  String // Never expose in UI after saving
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Owner
  owner   User   @relation(fields: [ownerId], references: [id], onDelete: Restrict)
  ownerId String

  // Shared access
  sharedWith UserPaperlessInstanceAccess[]

  // Related documents
  processedDocuments ProcessedDocument[]
  processingQueue    ProcessingQueue[]

  @@index([ownerId])
}

// =============================================================================
// AI Configuration
// =============================================================================

model AiProvider {
  id        String   @id @default(cuid())
  name      String
  provider  String // openai | anthropic | ollama | google | custom
  model     String
  apiKey    String // Never expose in UI after saving
  baseUrl   String? // Optional for Custom/Ollama endpoints
  isActive  Boolean  @default(true) // Soft-delete for audit trail
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Owner
  owner   User   @relation(fields: [ownerId], references: [id], onDelete: Restrict)
  ownerId String

  // Shared access
  sharedWith UserAiProviderAccess[]

  // Related bots
  bots           AiBot[]
  aiUsageMetrics AiUsageMetric[]

  @@index([ownerId])
  @@index([isActive])
}

model AiBot {
  id           String   @id @default(cuid())
  name         String
  systemPrompt String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Owner
  owner   User   @relation(fields: [ownerId], references: [id], onDelete: Restrict)
  ownerId String

  // AI Provider configuration
  aiProvider   AiProvider @relation(fields: [aiProviderId], references: [id], onDelete: Restrict)
  aiProviderId String

  // Shared access
  sharedWith UserAiBotAccess[]

  // Usage tracking
  aiUsageMetrics AiUsageMetric[]

  @@index([ownerId])
  @@index([aiProviderId])
}

// =============================================================================
// Document Processing
// =============================================================================

model ProcessedDocument {
  id          String   @id @default(cuid())
  paperlessId Int
  title       String
  processedAt DateTime @default(now())
  aiProvider  String
  tokensUsed  Int      @default(0)

  // Store what was changed
  changes Json?

  // Original values before processing
  originalTitle         String?
  originalCorrespondent String?
  originalDocumentType  String?
  originalTags          String[] @default([])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Link to Paperless instance
  paperlessInstance   PaperlessInstance @relation(fields: [paperlessInstanceId], references: [id], onDelete: Cascade)
  paperlessInstanceId String

  @@index([paperlessId])
  @@index([processedAt])
  @@index([paperlessInstanceId])
}

model ProcessingQueue {
  id           String    @id @default(cuid())
  paperlessId  Int
  status       String    @default("pending") // pending | processing | completed | failed
  priority     Int       @default(0)
  attempts     Int       @default(0)
  lastError    String?
  scheduledFor DateTime  @default(now())
  startedAt    DateTime?
  completedAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Link to Paperless instance
  paperlessInstance   PaperlessInstance @relation(fields: [paperlessInstanceId], references: [id], onDelete: Cascade)
  paperlessInstanceId String

  @@index([status, scheduledFor])
  @@index([paperlessId])
  @@index([paperlessInstanceId])
}

// =============================================================================
// Usage Tracking
// =============================================================================

model AiUsageMetric {
  id               String   @id @default(cuid())
  provider         String
  model            String
  promptTokens     Int
  completionTokens Int
  totalTokens      Int
  estimatedCost    Float?
  documentId       Int?
  createdAt        DateTime @default(now())

  // Who caused this usage
  user   User   @relation(fields: [userId], references: [id])
  userId String

  aiProvider   AiProvider @relation(fields: [aiProviderId], references: [id], onDelete: Restrict)
  aiProviderId String

  // Which bot was used (optional, for tracking)
  aiBot   AiBot?  @relation(fields: [aiBotId], references: [id], onDelete: SetNull)
  aiBotId String?

  @@index([createdAt])
  @@index([provider])
  @@index([userId])
  @@index([aiBotId])
}
